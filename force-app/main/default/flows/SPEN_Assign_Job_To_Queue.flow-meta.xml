<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>58.0</apiVersion>
    <assignments>
        <name>SPEN_Update_Job_Number</name>
        <label>Update Job Number</label>
        <locationX>776</locationX>
        <locationY>395</locationY>
        <assignmentItems>
            <assignToReference>$Record.Name</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>SPEN_JobNumberFieldValue</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>SPEN_NewJob_Or_IsChanged_WorkCategory</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>SPEN_UpdateStatusNoCertificateRequired</name>
        <label>Update status no certificate required</label>
        <locationX>776</locationX>
        <locationY>1295</locationY>
        <assignmentItems>
            <assignToReference>$Record.SPEN_JobStatus__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Full Job Released</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>SPEN_Licence_Area_Updated</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>SPEN_UpdateStatusOnCerticficateSelection</name>
        <label>Update status on certicficate selection</label>
        <locationX>512</locationX>
        <locationY>1295</locationY>
        <assignmentItems>
            <assignToReference>$Record.SPEN_JobStatus__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Job Released -Completion Certificate Required</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>SPEN_Licence_Area_Updated</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>SPEN_WCPlannedLeadTimePopulation</name>
        <label>Work Category Planned Lead Time Population</label>
        <locationX>490</locationX>
        <locationY>911</locationY>
        <assignmentItems>
            <assignToReference>$Record.SPEN_WorkCategory__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>SPEN_GetWorkCategoryRecords.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>$Record.SPEN_PlannedLeadTime__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>SPEN_GetWorkCategoryRecords.SPEN_LeadTime__c</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>WCUpdated</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Update_Queue</name>
        <label>Update Queue on Job</label>
        <locationX>50</locationX>
        <locationY>1811</locationY>
        <assignmentItems>
            <assignToReference>$Record.OwnerId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>getQueue1.Id</elementReference>
            </value>
        </assignmentItems>
    </assignments>
    <assignments>
        <name>Update_Queue_on_Job2</name>
        <label>Update Queue on Job</label>
        <locationX>314</locationX>
        <locationY>1811</locationY>
        <assignmentItems>
            <assignToReference>$Record.OwnerId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>getQueue2.Id</elementReference>
            </value>
        </assignmentItems>
    </assignments>
    <assignments>
        <name>Update_Queue_on_Job3</name>
        <label>Update Queue on Job</label>
        <locationX>578</locationX>
        <locationY>1811</locationY>
        <assignmentItems>
            <assignToReference>$Record.OwnerId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>getQueue3.Id</elementReference>
            </value>
        </assignmentItems>
    </assignments>
    <decisions>
        <name>LicenseArea</name>
        <label>LicenseArea</label>
        <locationX>446</locationX>
        <locationY>1595</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>SPEN_Transmission_Land_Planning_Queue</name>
            <conditionLogic>(1 OR 2) AND 3</conditionLogic>
            <conditions>
                <leftValueReference>$Record.SPEN_LicenseArea__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>SPT</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.SPEN_LicenseArea__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>SPM 132</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Owner:Group.DeveloperName</leftValueReference>
                <operator>NotEqualTo</operator>
                <rightValue>
                    <stringValue>SPEN_Transmission_Land_Planning_Queue</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>getQueue1</targetReference>
            </connector>
            <label>Transmission Land &amp; Planning Queue</label>
        </rules>
        <rules>
            <name>SPEN_Land_South_Queue_LAs_CAs_LOs</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.SPEN_LicenseArea__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>SPM</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Owner:Group.DeveloperName</leftValueReference>
                <operator>NotEqualTo</operator>
                <rightValue>
                    <stringValue>SPEN_Land_South_Queue_LAs_CAs_LOs</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>getQueue2</targetReference>
            </connector>
            <label>Land South Queue (LAs/CAs/LOs)</label>
        </rules>
        <rules>
            <name>SPEN_Land_North_Queue_LAs_CAs_LOs</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.SPEN_LicenseArea__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>SPD</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Owner:Group.DeveloperName</leftValueReference>
                <operator>NotEqualTo</operator>
                <rightValue>
                    <stringValue>SPEN_Land_South_Queue_LAs_CAs_LOs</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>getQueue3</targetReference>
            </connector>
            <label>Land North Queue (LAs/CAs/LOs)</label>
        </rules>
    </decisions>
    <decisions>
        <name>SPEN_IsNew_Record</name>
        <label>IsNew Record</label>
        <locationX>776</locationX>
        <locationY>287</locationY>
        <defaultConnector>
            <targetReference>SPEN_NewJob_Or_IsChanged_WorkCategory</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>SPEN_Job_Status_to_live</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.SPEN_Create_Job_in_Live__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>SPEN_isNewRecord</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>SPEN_Update_status_Live</targetReference>
            </connector>
            <label>Job Status to live</label>
        </rules>
        <rules>
            <name>SPEN_Job_Number_Update_Required</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>SPEN_isNewRecord</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.SPEN_LicenseArea__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Name</leftValueReference>
                <operator>NotEqualTo</operator>
                <rightValue>
                    <elementReference>SPEN_JobNumberFieldValue</elementReference>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>SPEN_Update_Job_Number</targetReference>
            </connector>
            <label>Job Number Update Required</label>
        </rules>
    </decisions>
    <decisions>
        <name>SPEN_Licence_Area_Updated</name>
        <label>Licence Area Updated</label>
        <locationX>776</locationX>
        <locationY>1487</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>IsLicenceAreaChanged</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.SPEN_LicenseArea__c</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.SPEN_LicenseArea__c</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>LicenseArea</targetReference>
            </connector>
            <label>IsLicenceAreaChanged</label>
        </rules>
    </decisions>
    <decisions>
        <name>SPEN_NewJob_Or_IsChanged_WorkCategory</name>
        <label>NewJob Or IsChanged WorkCategory</label>
        <locationX>776</locationX>
        <locationY>587</locationY>
        <defaultConnector>
            <targetReference>WCUpdated</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>SPEN_JobCreatedOrWCChanged</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>SPEN_NewJobOrWCUpdated</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>SPEN_GetWorkCategoryRecords</targetReference>
            </connector>
            <label>Job Created or WC Changed</label>
        </rules>
    </decisions>
    <decisions>
        <name>SPEN_WorkCategoryRecordsPresent</name>
        <label>Work Category Records Present</label>
        <locationX>622</locationX>
        <locationY>803</locationY>
        <defaultConnector>
            <targetReference>WCUpdated</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>SPEN_GotAtleastOneWorkCategoryRecord</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>SPEN_GetWorkCategoryRecords.Id</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>SPEN_WCPlannedLeadTimePopulation</targetReference>
            </connector>
            <label>Got Atleast One Work Category Record</label>
        </rules>
    </decisions>
    <decisions>
        <name>WCUpdated</name>
        <label>WCUpdated</label>
        <locationX>776</locationX>
        <locationY>1187</locationY>
        <defaultConnector>
            <targetReference>SPEN_Licence_Area_Updated</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>SPEN_Certification_Required_After_Job_Released</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.SPEN_JobStatus__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Job Released</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.SPEN_CertificateRequired__c</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.SPEN_CertificateRequired__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Completion Certificate Required</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>SPEN_UpdateStatusOnCerticficateSelection</targetReference>
            </connector>
            <label>SPEN Certification Required After Job Released</label>
        </rules>
        <rules>
            <name>SPEN_Certification_NR_After_Job_Released</name>
            <conditionLogic>(1 AND 2 AND 3) OR (4 AND 5 AND 6)</conditionLogic>
            <conditions>
                <leftValueReference>$Record.SPEN_JobStatus__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Job Released</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.SPEN_CertificateRequired__c</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.SPEN_CertificateRequired__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>No Completion Certificate required</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.SPEN_JobStatus__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Job Released -Completion Certificate Required</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.SPEN_CertificateCompletionDate__c</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.SPEN_CertificateCompletionDate__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>SPEN_UpdateStatusNoCertificateRequired</targetReference>
            </connector>
            <label>SPEN Certification NR After Job Released</label>
        </rules>
    </decisions>
    <description>ESC-921 Fix
This flow runs during job creation or update to assign the job to right queue.
Updated as part of ESC-393
ESC-726: Instruction Date changes.
ESC-814: Work Category lookup changes.
ESC-799 Updated Queue Assignment
ESC-1036 Updated Job Status on job released certificate completion required
ESC-1368 updated the condition to include Job Released -Completion Certificate Required</description>
    <environments>Default</environments>
    <formulas>
        <name>JobWorkCategoryUpdated</name>
        <dataType>Boolean</dataType>
        <expression>ISNEW() || ISCHANGED({!$Record.SPEN_WorkCategory__c})||  ISCHANGED({!$Record.SPEN_SubCategory__c})</expression>
    </formulas>
    <formulas>
        <name>PlannedLeadTimeValue</name>
        <dataType>Number</dataType>
        <expression>{!$Record.SPEN_WorkCategory__r.SPEN_Sum_LeadTime__c}</expression>
        <scale>0</scale>
    </formulas>
    <formulas>
        <name>SPEN_isNewRecord</name>
        <dataType>Boolean</dataType>
        <expression>ISNEW()</expression>
    </formulas>
    <formulas>
        <name>SPEN_JobNumberFieldValue</name>
        <dataType>String</dataType>
        <expression>TEXT($Record.SPEN_LicenseArea__c) &amp; &quot; &quot; &amp; $Record.SPEN_UniqueID__c</expression>
    </formulas>
    <formulas>
        <description>To check if the record is created or if the work category picklist field is updated</description>
        <name>SPEN_NewJobOrWCUpdated</name>
        <dataType>Boolean</dataType>
        <expression>OR(AND(ISNEW(), NOT(ISBLANK(TEXT( {!$Record.SPEN_Work_Category__c})))),ISCHANGED({!$Record.SPEN_Work_Category__c}))</expression>
    </formulas>
    <formulas>
        <name>SPEN_PlannedLeadTimeWCValue</name>
        <dataType>Number</dataType>
        <expression>IF({!$Record.SPEN_SubCategory__c}!=null, {!$Record.SPEN_SubCategory__r.SPEN_LeadTime__c}, {!$Record.SPEN_WorkCategory__r.SPEN_LeadTime__c})</expression>
        <scale>0</scale>
    </formulas>
    <interviewLabel>SPEN Assign Job To Queue {!$Flow.CurrentDateTime}</interviewLabel>
    <label>SPEN Assign Job To Queue</label>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>AUTO_LAYOUT_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordLookups>
        <name>getQueue1</name>
        <label>getQueue</label>
        <locationX>50</locationX>
        <locationY>1703</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Update_Queue</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Type</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Queue</stringValue>
            </value>
        </filters>
        <filters>
            <field>DeveloperName</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>SPEN_Transmission_Land_Planning_Queue</stringValue>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Group</object>
        <queriedFields>Id</queriedFields>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>getQueue2</name>
        <label>getQueue</label>
        <locationX>314</locationX>
        <locationY>1703</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Update_Queue_on_Job2</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Type</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Queue</stringValue>
            </value>
        </filters>
        <filters>
            <field>DeveloperName</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>SPEN_Land_South_Queue_LAs_CAs_LOs</stringValue>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Group</object>
        <queriedFields>Id</queriedFields>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>getQueue3</name>
        <label>getQueue</label>
        <locationX>578</locationX>
        <locationY>1703</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Update_Queue_on_Job3</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Type</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Queue</stringValue>
            </value>
        </filters>
        <filters>
            <field>DeveloperName</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>SPEN_Land_North_Queue_LAs_CAs_LOs</stringValue>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Group</object>
        <queriedFields>Id</queriedFields>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <description>Query out Work Category records based on Job record field values.</description>
        <name>SPEN_GetWorkCategoryRecords</name>
        <label>Get Work Category Records</label>
        <locationX>622</locationX>
        <locationY>695</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>SPEN_WorkCategoryRecordsPresent</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>SPEN_LicenseArea__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.SPEN_LicenseArea__c</elementReference>
            </value>
        </filters>
        <filters>
            <field>SPEN_WorkCategoryTitle__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.SPEN_Work_Category__c</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>SPEN_WorkCategory__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordUpdates>
        <name>SPEN_Update_status_Live</name>
        <label>Update status Live</label>
        <locationX>512</locationX>
        <locationY>395</locationY>
        <connector>
            <targetReference>SPEN_NewJob_Or_IsChanged_WorkCategory</targetReference>
        </connector>
        <inputAssignments>
            <field>SPEN_InstructionDate__c</field>
            <value>
                <elementReference>$Flow.CurrentDate</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>SPEN_JobStatus__c</field>
            <value>
                <stringValue>Live</stringValue>
            </value>
        </inputAssignments>
        <inputReference>$Record</inputReference>
    </recordUpdates>
    <start>
        <locationX>650</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>SPEN_IsNew_Record</targetReference>
        </connector>
        <object>SPEN_Job__c</object>
        <recordTriggerType>CreateAndUpdate</recordTriggerType>
        <triggerType>RecordBeforeSave</triggerType>
    </start>
    <status>Active</status>
</Flow>
